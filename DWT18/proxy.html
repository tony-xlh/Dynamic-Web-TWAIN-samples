<!DOCTYPE html>
<html>

<head>
  <title>Use Auto Feeder to scan</title>
  <script type="text/javascript" src="Resources/dynamsoft.webtwain.initiate.js"></script>
  <script type="text/javascript" src="Resources/dynamsoft.webtwain.config.js"></script>
</head>

<body>
  Server URL:
  <input id="serverURL" type="text" value="http://green142.scannerproxy.com:18887/"></input>
  <br/>
  Services:
  <select id="services" onChange="serviceSelected();"></select>
  <br/>
  Scanners:
  <select id="scanners" onChange="scannerSelected();"></select>
  <br/>
  <input id="scanButton" type="button" value="Scan" onclick="AcquireImage();"/>
  <div id="dwtcontrolContainer" style="width: 350px; height: 380px;"></div>
  <script type="text/javascript">
    Dynamsoft.DWT.RegisterEvent('OnWebTwainReady', Dynamsoft_OnReady); // Register OnWebTwainReady event. This event fires as soon as Dynamic Web TWAIN is initialized and ready to be used

    let DWObject;
    let RemoteDWObject;
    let services;
    let devices;
    

    function Dynamsoft_OnReady() {
      DWObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer'); // Get the Dynamic Web TWAIN object that is embeded in the div with id 'dwtcontrolContainer'
      console.log("ready");
      if (DWObject) {
        loadServices();
      }
    }

    async function serviceSelected(){
      console.log("serviceSelected");
      if (RemoteDWObject) {
        RemoteDWObject.dispose();
      }
      let servicesSelect = document.getElementById("services");
      let selectedService = services[servicesSelect.selectedIndex];
      RemoteDWObject = await Dynamsoft.DWT.CreateDWTObjectAsync(selectedService);
      loadScanners();
    }

    function scannerSelected(){
      console.log("scannerSelected");

    }

    async function loadServices(){
      let servicesSelect = document.getElementById("services");
      servicesSelect.innerHTML = "";
      let serverURL = document.getElementById("serverURL").value;
      services = await Dynamsoft.DWT.FindDynamsoftServiceAsync(serverURL);
      services.forEach(service => {
        let option = new Option();
        option.value = service.attrs.hostname;
        option.text = service.attrs.hostname;
        servicesSelect.appendChild(option);
      });
      serviceSelected();
    }

    async function loadScanners(){
      let scannersSelect = document.getElementById("scanners");
      scannersSelect.innerHTML = "";
      devices = await RemoteDWObject.GetDevicesAsync();
      devices.forEach(device => {
        console.log(device);
        let option = new Option();
        option.value = device.displayName;
        option.text = device.displayName;
        scannersSelect.appendChild(option);
      });
    }
    
    async function AcquireImage() {
      if (RemoteDWObject) {
        let scannersSelect = document.getElementById("scanners");
        let device = devices[scannersSelect.selectedIndex];
        await RemoteDWObject.SelectDeviceAsync(device);
        await RemoteDWObject.AcquireImageAsync({IfShowUI:false},DWObject);
      }
    }
  </script>
</body>

</html>